<!doctype html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head(~{::extraHead})}"></head>

<body class="sidebar-expand-lg sidebar-open bg-body-tertiary">
	<!-- 子頁額外樣式：只放 DataTables 的 Bootstrap5 佈景（放在 body 裡，讓 head 的片段替換更穩定） -->
	<th:block th:fragment="extraHead">
		<link rel="stylesheet"
			href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.min.css">
		<style>
/* 長字串欄為樣式*/
.long-cell {
	white-space: nowrap; /* 不自動換行 */
	max-width: 500px; /* 最大寬度 */
}
</style>
	</th:block>

	<!-- 用版型把下面兩個片段插入（容器會被整個替換，不會重複渲染） -->
	<div th:replace="~{admin/layout :: layout(~{::content}, ~{::extraJs})}">
		<!-- 內容區（fragment） -->
		<section th:fragment="content">
			<div th:if="${errorMessage}" class="alert alert-danger" role="alert">
				<span th:text="${errorMessage}"></span>
			</div>
			<div class="card">
				<div
					class="card-header d-flex justify-content-between align-items-center">
					<h3 class="card-title mb-0">訂單管理</h3>
					<div class="ms-auto">
						<a class="btn btn-sm btn-outline-secondary"
							th:href="@{/admin/orders/list}">顯示全部訂單
						</a>
					</div>
				</div>
				
				<br>
				<div class="container">
					<form th:action="@{/admin/orders/search}" method="get"
						class="row g-3 mb-3">
						<div th:if="${noResult}" class="alert alert-warning" role="alert">
							查無資料，請嘗試其他查詢條件。</div>
						<div class="col-md-3">
							<label class="form-label">訂單編號</label> <input type="text"
								class="form-control" name="orderNo" placeholder="模糊查詢">
						</div>
						<div class="col-md-3">
							<label class="form-label">金額（最低）</label> <input type="number"
								step="0.01" class="form-control" name="minAmount">
						</div>
						<div class="col-md-3">
							<label class="form-label">金額（最高）</label> <input type="number"
								step="0.01" class="form-control" name="maxAmount">
						</div>
						<div class="col-md-3">
							<label class="form-label">會員ID</label> <input type="text"
								class="form-control" name="memberId">
						</div>
						<div class="col-md-3">
							<label class="form-label">訂單成立時間（起）</label> <input
								type="datetime-local" class="form-control" name="startTime">
						</div>
						<div class="col-md-3">
							<label class="form-label">訂單成立時間（訖）</label> <input
								type="datetime-local" class="form-control" name="endTime">
						</div>
						<div class="col-md-3 align-self-end">
							<button type="submit" class="btn btn-primary">查詢</button>
						</div>
					</form>
				</div>

				<div class="card-body">
					<div class="table-responsive">
						<table id="ordersTable"
							class="table table-striped table-bordered align-middle w-100">
							<thead>
								<tr>
									<th class="text-center align-middle">訂單ID</th>
									<th class="text-center align-middle">會員ID</th>
									<th class="text-center align-middle">訂單編號</th>
									<th class="text-center align-middle long-cell">訂單成立時間</th>
									<th class="text-center align-middle long-cell">狀態</th>
									<th class="text-center align-middle">金額</th>
									<th class="text-center align-middle long-cell">收件人</th>
									<th class="text-center align-middle long-cell">地址</th>
									<th class="text-center align-middle">電話</th>
									<th class="text-center align-middle">Email</th>
									<th class="text-center align-middle long-cell">備註</th>
									<th class="text-center align-middle long-cell">更新時間</th>
									<th class="text-center align-middle">訂單明細</th>
									<th class="text-center align-middle">操作</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="ordersVO  : ${ordersList}">
									<td class="text-center align-middle"
										th:text="${ordersVO.orderId}"></td>
									<td class="text-center align-middle"
										th:text="${ordersVO.memberVO.memberId}"></td>
									<td class="text-center align-middle"
										th:text="${ordersVO.orderNo}"></td>
									<td class="text-center align-middle long-cell"><span
										th:text="${#temporals.format(ordersVO.orderTime, 'yyyy年MM月dd日')}"></span><br>
										<span
										th:text="${#temporals.format(ordersVO.orderTime, 'HH:mm')}"></span>
									</td>
									<td class="text-center align-middle long-cell"><span
										th:switch="${ordersVO.status}"> <span th:case="0">已取消</span>
											<span th:case="1">未付款</span> <span th:case="2">已付款</span> <span
											th:case="3">已出貨</span> <span th:case="4">已收貨</span> <span
											th:case="5">退款中</span> <span th:case="6">已退款</span>
									</span></td>
									<td class="text-center align-middle"
										th:text="${ordersVO.amount}"></td>
									<td class="text-center align-middle long-cell"
										th:text="${ordersVO.recipient}"></td>
									<td class="text-center align-middle long-cell"
										th:text="${ordersVO.address}"></td>
									<td class="text-center align-middle"
										th:text="${ordersVO.phone}"></td>
									<td class="text-center align-middle"
										th:text="${ordersVO.email}"></td>
									<td class="text-center align-middle long-cell"
										th:text="${ordersVO.remark}"></td>
									<td class="text-center align-middle long-cell"><span
										th:text="${#temporals.format(ordersVO.updateTime, 'yyyy年MM月dd日')}"></span><br>
										<span
										th:text="${#temporals.format(ordersVO.updateTime, 'HH:mm')}"></span>
									<td class="text-nowrap"><a
										class="btn btn-sm btn-outline-success"
										th:href="@{|/admin/orderdetail/detail?orderId=${ordersVO.orderId}|}">
											<i class="bi bi-journal-medical"></i> 訂單明細 <span
											class="badge text-bg-info ms-1"
											th:text="${listCountMap != null and listCountMap[ordersVO.orderId] != null ? listCountMap[ordersVO.orderId] : 0}">0</span>
									</a></td>
									<td class="text-nowrap">
										<form th:action="@{/admin/orders/getOne_For_Update}"
											method="post" class="d-inline">
											<input type="hidden" name="orderId"
												th:value="${ordersVO.orderId}" />
											<button type="submit" class="btn btn-sm btn-outline-primary">
												<i class="bi bi-pencil-square"></i> 修改
											</button>
										</form>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

			</div>
		</section>

		<!-- 本頁 JS（fragment） -->
		<th:block th:fragment="extraJs">
			<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
			<script src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js"></script>
			<script
				src="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.min.js"></script>
			<script>
				document
						.addEventListener(
								'DOMContentLoaded',
								function() {
									const sel = '#ordersTable';
									if ($.fn.DataTable.isDataTable(sel))
										return; // 防止重複初始化
									$(sel)
											.DataTable(
													{
														retrieve : true,
														lengthMenu : [ 3, 5,
																10, 20, 50, 100 ],
														language : {
															processing : "處理中...",
															loadingRecords : "載入中...",
															lengthMenu : "顯示 _MENU_ 筆結果",
															zeroRecords : "沒有符合的結果",
															info : "顯示第 _START_ 至 _END_ 筆結果，共 <span class='text-danger'>_TOTAL_</span> 筆",
															infoEmpty : "顯示第 0 至 0 筆結果，共 0 筆",
															infoFiltered : "(從 _MAX_ 筆結果中過濾)",
															search : "搜尋：",
															paginate : {
																first : "第一頁",
																previous : "上一頁",
																next : "下一頁",
																last : "最後一頁"
															},
															aria : {
																sortAscending : ": 升冪排列",
																sortDescending : ": 降冪排列"
															}
														}
													});
								});
			</script>
		</th:block>
	</div>
</body>
</html>
