<!doctype html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head(~{::extraHead})}"></head>

<body class="sidebar-expand-lg bg-body-tertiary">
  <!-- 本頁額外 CSS -->
  <th:block th:fragment="extraHead">
    <style>
      .preview-img{width:120px;height:90px;object-fit:cover;border-radius:.25rem}
    </style>
  </th:block>

  <!-- 用 layout 取代此容器，並把 content / extraJs 傳入 -->
  <div th:replace="~{admin/layout :: layout(content=~{::content}, extraJs=~{::extraJs})}">

    <section th:fragment="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">媽媽手冊｜修改</h3>
            <a class="btn btn-sm btn-outline-secondary" th:href="@{/admin/mhb/list}">
              <i class="bi bi-arrow-left"></i> 回列表
            </a>
          </div>

          <div class="card-body">
            <form th:action="@{/mhb/update}" method="post" th:object="${mhbVO}" enctype="multipart/form-data" class="row g-3">
              <!-- 供 @NotNull 的 memberId 綁定；日後可改成登入者 id -->
              <input type="hidden" th:field="*{memberId}" value="1"/>
              <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

              <div class="col-md-6">
                <label class="form-label">手冊編號</label>
                <input type="text" th:field="*{motherHandbookId}" class="form-control-plaintext fw-semibold" readonly/>
              </div>

              <div class="col-md-6">
                <label class="form-label">媽媽姓名</label>
                <input type="text" th:field="*{motherName}" class="form-control"
                       th:classappend="${#fields.hasErrors('motherName')}? ' is-invalid'"/>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('motherName')}" th:errors="*{motherName}"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">媽媽生日</label>
                <input type="date" th:field="*{motherBirthday}" class="form-control"
                       th:classappend="${#fields.hasErrors('motherBirthday')}? ' is-invalid'"/>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('motherBirthday')}" th:errors="*{motherBirthday}"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">最後一次月經</label>
                <input type="date" th:field="*{lastMcDate}" class="form-control"
                       th:classappend="${#fields.hasErrors('lastMcDate')}? ' is-invalid'"/>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('lastMcDate')}" th:errors="*{lastMcDate}"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">預計生產日</label>
                <input type="date" th:field="*{expectedBirthDate}" class="form-control"
                       th:classappend="${#fields.hasErrors('expectedBirthDate')}? ' is-invalid'"/>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('expectedBirthDate')}" th:errors="*{expectedBirthDate}"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">體重</label>
                <input type="number" th:field="*{weight}" min="0" step="0.01" class="form-control"
                       th:classappend="${#fields.hasErrors('weight')}? ' is-invalid'"/>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('weight')}" th:errors="*{weight}"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">照片（不選則維持原圖）</label>
                <input id="upFiles"
                       type="file"
                       th:field="*{upFiles}"
                       accept="image/*"
                       class="form-control"
                       onchange="(function(el){
                         var preview=document.getElementById('preview');
                         var current=document.getElementById('currentPhoto');
                         if(!preview){return;}
                         var f=el.files&&el.files[0];
                         if(!f){
                           // 沒選檔：隱藏新預覽，顯示舊圖/占位
                           preview.classList.add('d-none'); preview.removeAttribute('src');
                           if(current) current.classList.remove('d-none');
                           return;
                         }
                         var ok=(f.type&&f.type.indexOf('image/')===0) || /\.(png|jpe?g|gif|webp|bmp|heic|heif|tiff?)$/i.test(f.name||'');
                         if(!ok){
                           preview.classList.add('d-none'); preview.removeAttribute('src');
                           if(current) current.classList.remove('d-none');
                           return;
                         }
                         var url=(window.URL||window.webkitURL).createObjectURL(f);
                         preview.onload=function(){ (window.URL||window.webkitURL).revokeObjectURL(url); };
                         preview.src=url;
                         preview.classList.remove('d-none');
                         if(current) current.classList.add('d-none'); // 選新檔就隱藏舊圖/占位
                       })(this)"/>

                <div class="mt-2 d-flex align-items-center gap-3">
                  <!-- 目前照片（有圖才顯示）或占位（無圖時顯示）。兩者共用同一個 id 以便上面 JS 控制 -->
                  <img th:if="${mhbVO.upFiles != null}"
                       th:src="@{'/mhb/photo/' + ${mhbVO.motherHandbookId}}"
                       class="preview-img" id="currentPhoto" alt="目前照片">
                  <div th:if="${mhbVO.upFiles == null}"
                       id="currentPhoto"
                       class="text-body-secondary border rounded px-3 py-2">目前無照片</div>

                  <!-- 新檔預覽 -->
                  <img id="preview" class="preview-img d-none" alt="新檔預覽">
                </div>
              </div>

              <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> 送出修改</button>
                <a class="btn btn-outline-secondary" th:href="@{/admin/mhb/list}">取消</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- 本頁不需額外 JS -->
    <th:block th:fragment="extraJs"></th:block>
  </div>
</body>
</html>
