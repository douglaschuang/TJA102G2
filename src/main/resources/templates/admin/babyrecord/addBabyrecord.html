<!doctype html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head(~{::extraHead})}"></head>

<body class="sidebar-expand-lg bg-body-tertiary">
	<!-- 本頁額外 CSS -->
	<th:block th:fragment="extraHead">
	<style>
		.preview-img {
			max-width: 160px;
			max-height: 120px;
			object-fit: cover;
			border-radius: .25rem;
		}
	</style>
	</th:block>

	<!-- 用 layout 取代此容器，並把 content / extraJs 傳入 -->
	<div
		th:replace="~{admin/layout :: layout(content=~{::content}, extraJs=~{::extraJs})}">

		<section th:fragment="content">
			<div class="container-fluid">
				<div class="card">
					<div class="card-header d-flex justify-content-between align-items-center">
						<h3 class="card-title mb-0">小孩記錄管理｜新增</h3>
						<a class="btn btn-sm btn-outline-secondary"
							th:href="@{/admin/babyrecord/records}"> 
							<i class="bi bi-arrow-left"></i> 回列表
						</a>
					</div>

					<div class="card-body">
						<!-- 一定要 multipart -->
						<form th:action="@{/admin/babyrecord/insert}" method="post"
							th:object="${babyrecordVO}" enctype="multipart/form-data"
							class="row g-3">
							<!-- 供 @NotNull 的 memberId 綁定；日後可改成登入者 id -->
							<input type="hidden" th:field="*{babyhandbook.babyhandbookid}"/> 
							<input
								th:if="${_csrf != null}" type="hidden"
								th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

							<div class="col-md-6">
								<label class="form-label">小孩週數:</label> 
								<input type="text"
									th:field="*{babyweek}" class="form-control"
									th:classappend="${#fields.hasErrors('babyweek')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('babyweek')}"
									th:errors="*{babyweek}"></div>
							</div>

							<div class="col-md-6">
								<label class="form-label">檢查日:</label>
								<input type="date"
									th:field="*{visitdate}" class="form-control"
									th:classappend="${#fields.hasErrors('visitdate')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('visitdate')}"
									th:errors="*{visitdate}"></div>
							</div>

							<div class="col-md-6">
								<label class="form-label">診所 ID:</label> 
								<input type="text"
									th:field="*{clinicid}" class="form-control"
									th:classappend="${#fields.hasErrors('clinicid')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('clinicid')}"
									th:errors="*{clinicid}"></div>
							</div>		
												
							<div class="col-md-6">
								<label class="form-label">檢查記錄:</label> 
								<input type="text"
									th:field="*{bodycondition}" class="form-control"
									th:classappend="${#fields.hasErrors('bodycondition')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('bodycondition')}"
									th:errors="*{bodycondition}"></div>
							</div>							

							<div class="col-md-6">
								<label class="form-label">下次檢查日:</label>
								<input type="date"
									th:field="*{nextcheckdate}" class="form-control"
									th:classappend="${#fields.hasErrors('nextcheckdate')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('nextcheckdate')}"
									th:errors="*{nextcheckdate}"></div>
							</div>
							
							<div class="col-md-6">
								<label class="form-label">下次提醒:</label>
								<input type="text"
									th:field="*{nextreminder}" class="form-control"
									th:classappend="${#fields.hasErrors('nextreminder')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('nextreminder')}"
									th:errors="*{nextreminder}"></div>
							</div>
							
							<div class="col-md-6">
								<label class="form-label">身高:</label>
								<input type="text"
									th:field="*{height}" class="form-control"
									th:classappend="${#fields.hasErrors('height')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('height')}"
									th:errors="*{height}"></div>
							</div>
							
							<div class="col-md-6">
								<label class="form-label">體重:</label>
								<input type="text"
									th:field="*{weight}" class="form-control"
									th:classappend="${#fields.hasErrors('weight')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('weight')}"
									th:errors="*{weight}"></div>
							</div>
							
							<div class="col-md-6">
								<label class="form-label">頭圍:</label>
								<input type="text"
									th:field="*{hc}" class="form-control"
									th:classappend="${#fields.hasErrors('hc')}? ' is-invalid'" />
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('hc')}"
									th:errors="*{hc}"></div>
							</div>

							<div class="col-md-6">
								<label class="form-label">照片:</label> 
								<input type="file" class="form-control"
									th:field="*{babyrecordfiles}" 
									onchange="previewImage(); hideContent('babyrecordfiles.errors');"
									accept="image/*" />
							
							<div class="text-danger small" th:utext="${errorMessage}" id="babyhandbookfiles.errors"></div>
							
							<!-- 預覽區 -->
							<div class="mt-2">
								<img id="preview" class="img-thumbnail preview-img d-none"
									alt="預覽圖">
							</div>
							
							</div>

							<div class="col-12 d-flex gap-2">
								<button type="submit" class="btn btn-primary">
								<i class="bi bi-check2-circle"></i> 送出新增
								</button>
								<a class="btn btn-outline-secondary"
									th:href="@{/admin/babyhandbook/records}">取消</a>
					</div>
					</form>
				</div>
			</div>
		</section>

		<!-- 本頁不需額外 JS -->
		<th:block th:fragment="extraJs">
			<script>
				function previewImage() {
					const input = document.querySelector('input[type="file"]');
					const preview = document.getElementById('preview');
					const file = input.files[0];

					if (file) {
						const reader = new FileReader();
						reader.onload = function(e) {
							preview.src = e.target.result;
							preview.classList.remove('d-none');
						};
						reader.readAsDataURL(file);
					}
				}
			</script>
		</th:block>
	</div>
</body>
</html>
