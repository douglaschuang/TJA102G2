<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{frontend/forum_layout :: forumHead('論壇首頁', null)}"></head>

<body th:replace="~{frontend/forum_layout :: forumLayout(
    pageTitle = '論壇首頁',
    headerType = 'forum',
    content = ~{:: pageContent},
    extraJs = ~{:: pageScripts},  
    footerClass = 'footer-one',
    breadcrumbTitle = '論壇'
)}">

    <th:block th:fragment="pageContent">
        <div class="row">
            <div class="col-lg-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">最新文章</h3>
                    
                   <a th:if="${session.member != null}" th:href="@{/forum/my-likes}" class="btn btn-info">我的收藏</a>

<a th:unless="${session.member != null}" th:href="@{/shop/login}" class="btn btn-info">我的收藏</a>
                </div>
            </div>
            <div class="col-lg-12" th:replace="~{frontend/forum_layout :: postList(${postPage.content}, ${postPage.number + 1}, ${postPage.totalPages})}"></div>
        </div>
    </th:block>

    <th:block th:fragment="pageScripts">
        <script>
     // 等待整個網頁文件都載入完成後再執行

        document.addEventListener("DOMContentLoaded", function() {



            // 找到頁面上所有 class 為 "like-btn" 的按鈕

            const likeButtons = document.querySelectorAll('.like-btn');



            // 為每一個按鈕加上點擊事件監聽器

            likeButtons.forEach(button => {

                button.addEventListener('click', function(event) {

                    

                    // 阻止 <a> 標籤的預設跳轉行為

                    event.preventDefault(); 



                    // 從按鈕的 data-post-id 屬性中讀取文章 ID

                    const postId = this.dataset.postId;

                    

                    // 準備發送 AJAX 請求

                    fetch(`/api/posts/${postId}/toggle-like`, {

                        method: 'POST',

                        headers: {

                            'Content-Type': 'application/json',

                            // 如果你的 Spring Security 有 CSRF 保護，還需要加上 token header

                        },

                    })

                    .then(response => {

                        if (!response.ok) {

                            // 如果伺服器返回錯誤 (例如 401 未登入)，就跳出提示

                            alert('請先登入才能收藏文章！');

                            throw new Error('Server returned an error');

                        }

                        return response.json(); // 解析伺服器返回的 JSON 資料

                    })

                    .then(data => {

                        // data 會是像 { "liked": true } 或 { "liked": false } 的物件

                        // 根據返回的最新狀態，更新愛心圖示

                        if (data.liked) {

                            this.innerHTML = '<span>❤️</span>'; // 更新為實心愛心

                        } else {

                            this.innerHTML = '<span>♡</span>'; // 更新為空心愛心

                        }

                    })

                    .catch(error => {

                        console.error('Error:', error);

                    });

                });

            });



        });
        </script>
    </th:block>

</body>
</html>