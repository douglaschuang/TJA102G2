<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>新增日記</title>
<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
.preview-img {
	max-width: 320px; /* 你也可以改 240、400… */
	max-height: 200px;
	object-fit: cover; /* 等比例裁切填滿 */
}

/* 基底：膠囊 badge */
.wx-badge {
	display: inline-flex;
	align-items: center;
	gap: .4rem;
	padding: .25rem .6rem;
	border-radius: 999px;
	font-size: .95rem;
	line-height: 1;
	font-weight: 600;
	box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
}

.wx-badge i {
	font-size: 1.1rem;
	vertical-align: -2px;
}

/* BabyMate 調色： */
.wx-sun {
	background: #FFDCDC;
	color: #6F4E37;
} /* 晴、穩定好天 */
.wx-cloud {
	background: #FFEAEA;
	color: #6F4E37;
} /* 多雲、陰天 */
.wx-rain {
	background: #9ECAD6;
	color: #0b3b4a;
} /* 陣雨、毛毛雨、雨 */
.wx-thunder {
	background: #F5CBCB;
	color: #5a2a2a;
} /* 雷雨、強對流 */
.wx-snow {
	background: #E7F4FA;
	color: #164a5b;
} /* 雪、霰 */
.wx-fog {
	background: #EDEDED;
	color: #444;
} /* 霧、霜霧 */
.wx-unknown {
	background: #e6e6e6;
	color: #333;
} /* 無法辨識 */
</style>


</head>
<body class="container py-4">
	<h4 class="mb-3 d-flex justify-content-between align-items-center">
		<span>新增日記</span> <small class="text-muted" id="weatherBadge">天氣查詢中…</small>
	</h4>
	<form th:action="@{/u/diary}" method="post" class="row g-3"
		enctype="multipart/form-data">
		<!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/> -->
		<input type="hidden" th:if="${_csrf != null}"
			th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

		<!-- 寫到資料庫的隱藏欄位（後端記得接收） -->
		<input type="hidden" name="weatherText" id="weatherText"> <input
			type="hidden" name="weatherTempC" id="weatherTempC">


		<div class="col-md-8">
			<label class="form-label">標題（可選）</label> <input class="form-control"
				type="text" name="title" placeholder="今天的心情…">
		</div>
		<div class="col-md-4">
			<label class="form-label">撰寫時間</label> <input class="form-control"
				type="datetime-local" name="writtenAt" th:value="${now}">
		</div>

		<div class="col-12">
			<label class="form-label">內容</label>
			<textarea class="form-control" name="content" rows="8" required></textarea>
		</div>

		<div class="col-12">
			<label class="form-label">標籤（可選，逗號分隔）</label> <input
				class="form-control" type="text" name="tags"
				placeholder="孕期, 心情, 待辦">
		</div>
		
		<div class="col-12">
			<label class="form-label">封面圖片（可選）</label> <input
				class="form-control" type="file" name="image" accept="image/*"
				id="coverInput"> <small class="text-muted">最多上傳一張，建議小於
				3MB。</small>

			<!-- 預覽區 -->
			<div id="imagePreview" class="d-none mt-2">
				<img id="previewImg" alt="預覽圖" class="rounded border preview-img">
				<div class="mt-2">
					<button type="button" class="btn btn-sm btn-outline-secondary"
						id="removeImgBtn">移除圖片</button>
				</div>
			</div>
		</div>


		<div class="col-12">
			<button class="btn btn-primary" type="submit">儲存</button>
			<a class="btn btn-outline-secondary"
				th:href="@{/blog/full-grid-left(tab='diary')}">返回日記</a>
		</div>
	</form>

	<script>
(function(){
  const badgeEl = document.getElementById('weatherBadge');
  const hidText = document.getElementById('weatherText');
  const hidTemp = document.getElementById('weatherTempC');

  // weathercode -> {icon, text, tone}
  function mapCode(code){
    if (code === 0)                 return { icon:'sun',                 text:'晴朗',        tone:'sun' };
    if (code === 1 || code === 2)   return { icon:'cloud-sun',           text:'多雲時晴',    tone:'sun' };
    if (code === 3)                 return { icon:'cloud',               text:'陰天',        tone:'cloud' };
    if (code === 45 || code === 48) return { icon:'cloud-fog',           text:'霧/霜霧',     tone:'fog' };
    if ([51,53,55].includes(code))  return { icon:'cloud-drizzle',       text:'毛毛雨',      tone:'rain' };
    if ([56,57].includes(code))     return { icon:'cloud-sleet',         text:'凍毛毛雨',    tone:'rain' };
    if ([61,63,65].includes(code))  return { icon:'cloud-rain',          text:'小/中/大雨',  tone:'rain' };
    if ([66,67].includes(code))     return { icon:'cloud-sleet',         text:'凍雨',        tone:'rain' };
    if ([80,81,82].includes(code))  return { icon:'cloud-rain-heavy',    text:'陣雨',        tone:'rain' };
    if ([71,73,75,77,85,86].includes(code))
                                     return { icon:'snow',               text:'降雪/霰',     tone:'snow' };
    if (code === 95)                return { icon:'cloud-lightning',     text:'雷雨',        tone:'thunder' };
    if (code === 96 || code === 99) return { icon:'cloud-lightning-rain',text:'強雷雨/冰雹', tone:'thunder' };
    return { icon:'cloud', text:'不明', tone:'unknown' };
  }

  // 取代原本的 renderWeather
  window.renderWeather = function(data){
    if (!data?.ok){
      badgeEl.textContent = '天氣取得失敗';
      badgeEl.className = '';
      return;
    }
    const t = (typeof data.tempC === 'number' && !Number.isNaN(data.tempC)) ? Math.round(data.tempC) : null;
    const m = mapCode(data.code);

    badgeEl.className = `wx-badge wx-${m.tone}`;
    badgeEl.innerHTML = `<i class="bi bi-${m.icon}" aria-hidden="true"></i>
                         <span>${m.text}${t!==null ? ` · 約 ${t}°C` : ''}</span>`;

    // 寫入隱藏欄位（保留原本要存 DB 的值）
    hidText.value = data.text || m.text;
    hidTemp.value = (t===null ? '' : String(t));
  };

  // === 呼叫 API 的流程 ===
  function fetchWeather(lat, lon){
    fetch(`/api/weather/now?lat=${lat}&lon=${lon}`, { credentials: 'same-origin' })
      .then(r=>r.ok ? r.json() : Promise.reject(r.status))
      .then(renderWeather)
      .catch(()=>{ badgeEl.textContent = '天氣取得失敗'; badgeEl.className='wx-badge wx-unknown'; });
  }

  const fallback = { lat:25.0418, lon:121.5650 };
  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
      _   => fetchWeather(fallback.lat, fallback.lon),
      { enableHighAccuracy:false, timeout:4000, maximumAge:300000 }
    );
  } else {
    fetchWeather(fallback.lat, fallback.lon);
  }
})();
</script>
	<script>
(function(){
  const input     = document.getElementById('coverInput');
  const box       = document.getElementById('imagePreview');
  const img       = document.getElementById('previewImg');
  const removeBtn = document.getElementById('removeImgBtn');
  const form      = document.querySelector('form[th\\:action], form[action]') || document.querySelector('form');

  let objectUrl = null;

  function clearPreview() {
    if (objectUrl) {
      URL.revokeObjectURL(objectUrl);
      objectUrl = null;
    }
    img.removeAttribute('src');
    box.classList.add('d-none');
    // 清空 input
    input.value = '';
  }

  input.addEventListener('change', () => {
    const file = input.files && input.files[0];
    if (!file) {
      clearPreview();
      return;
    }
    // 基本檢查：類型與大小（3MB）
    const isImage = file.type.startsWith('image/');
    const isOkSize = file.size <= 3 * 1024 * 1024;
    if (!isImage) {
      alert('請選擇圖片檔案（jpg/png/webp…）');
      clearPreview();
      return;
    }
    if (!isOkSize) {
      alert('圖片大於 3MB，請壓縮後再上傳');
      clearPreview();
      return;
    }
    // 顯示預覽
    if (objectUrl) URL.revokeObjectURL(objectUrl);
    objectUrl = URL.createObjectURL(file);
    img.src = objectUrl;
    box.classList.remove('d-none');
  });

  removeBtn.addEventListener('click', clearPreview);

  // 表單 reset 也清空預覽
  if (form) {
    form.addEventListener('reset', () => {
      // 延遲到瀏覽器把欄位重置完（避免 race）
      setTimeout(clearPreview, 0);
    });
  }
})();
</script>


</body>
</html>
