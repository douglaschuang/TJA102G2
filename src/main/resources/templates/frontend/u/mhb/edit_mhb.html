<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>編輯媽媽手冊</title>
<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
</head>

<body class="container py-4">
	<h4 class="mb-3">編輯媽媽手冊</h4>

	<form th:action="@{'/u/mhb/' + ${mhbVO.motherHandbookId} + '/edit'}"
		th:object="${mhbVO}" method="post" enctype="multipart/form-data"
		class="row g-3">

		<!-- CSRF（null-safe） -->
		<input type="hidden" th:if="${_csrf != null}"
			th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">

		<!-- 會員綁定（後端仍會以 session 覆蓋） -->
		<input type="hidden" th:field="*{memberId}" />

		<div class="col-md-6">
			<label class="form-label">手冊編號</label> <input
				class="form-control-plaintext fw-semibold"
				th:value="${mhbVO.motherHandbookId}" readonly>
		</div>

		<div class="col-md-6">
			<label class="form-label">媽媽姓名</label> <input class="form-control"
				type="text" th:field="*{motherName}" required>
		</div>

		<div class="col-md-4">
			<label class="form-label">媽媽生日</label> <input class="form-control"
				type="date" th:field="*{motherBirthday}">
		</div>

		<div class="col-md-4">
			<label class="form-label">末次月經</label> <input class="form-control"
				type="date" th:field="*{lastMcDate}">
		</div>

		<div class="col-md-4">
			<label class="form-label">預產期</label> <input class="form-control"
				type="date" th:field="*{expectedBirthDate}">
		</div>

		<div class="col-md-4">
			<label class="form-label">目前體重(kg)</label> <input
				class="form-control" type="number" step="0.01" min="0"
				th:field="*{weight}">
		</div>

		<div class="col-md-8">
			<label class="form-label">封面圖（不選則維持原圖）</label>
			<!-- 重點：name 用 "up"，不要叫 upFiles，避免自動綁到 byte[] -->
			<input id="upInput" class="form-control" type="file" name="up" accept="image/*">
			<!-- <div class="mt-2">
        <img th:if="${mhbVO.upFiles != null}"
             th:src="@{'/mhb/photo/' + ${mhbVO.motherHandbookId}}"
             style="width:120px;height:90px;object-fit:cover;border-radius:.25rem" alt="目前照片">
      </div> -->
			<div class="mt-2 d-flex align-items-center gap-3">
				<!-- 目前照片（有圖才顯示） -->
				<img id="currentPhoto" th:if="${mhbVO.upFiles != null}"
					th:src="@{'/mhb/photo/' + ${mhbVO.motherHandbookId}}"
					style="width: 120px; height: 90px; object-fit: cover; border-radius: .25rem"
					alt="目前照片">

				<!-- 沒有舊圖時的占位 -->
				<div id="noPhoto" th:if="${mhbVO.upFiles == null}"
					class="text-body-secondary border rounded px-3 py-2">目前無照片</div>

				<!-- 新檔預覽（初始隱藏） -->
				<img id="preview" class="d-none"
					style="width: 120px; height: 90px; object-fit: cover; border-radius: .25rem"
					alt="新檔預覽">
			</div>
		</div>

		<div class="col-12">
			<button class="btn btn-primary" type="submit">儲存</button>
			<a class="btn btn-outline-secondary"
				th:href="@{/blog/full-grid-left(tab='mhb', mhbId=${mhbVO.motherHandbookId})}">
				返回 </a>
		</div>
	</form>
	<script>
(function () {
  const input   = document.getElementById('upInput');
  const preview = document.getElementById('preview');
  const current = document.getElementById('currentPhoto');
  const noPhoto = document.getElementById('noPhoto');

  if (!input) return;
  let lastURL = null;

  input.addEventListener('change', function () {
    const f = this.files && this.files[0];

    // 沒選或清除檔案：還原顯示
    if (!f) {
      if (preview) {
        preview.classList.add('d-none');
        preview.removeAttribute('src');
      }
      if (current) current.classList.remove('d-none');
      if (noPhoto) noPhoto.classList.remove('d-none');
      return;
    }

    // 基本型別檢查（副檔名或 MIME）
    const ok = (f.type && f.type.indexOf('image/') === 0) ||
               /\.(png|jpe?g|gif|webp|bmp|heic|heif|tiff?)$/i.test(f.name || '');
    if (!ok) {
      alert('請選擇圖片檔。');
      this.value = ''; // 清掉不合法的選擇
      return;
    }

    // 釋放舊 URL，避免記憶體洩漏
    if (lastURL) URL.revokeObjectURL(lastURL);

    // 建立預覽 URL
    const url = URL.createObjectURL(f);
    lastURL = url;

    // 顯示新預覽，隱藏舊圖/占位
    if (preview) {
      preview.src = url;
      preview.classList.remove('d-none');
    }
    if (current) current.classList.add('d-none');
    if (noPhoto) noPhoto.classList.add('d-none');
  });
})();
</script>
</body>
</html>
