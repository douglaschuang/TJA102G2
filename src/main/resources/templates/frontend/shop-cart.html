<!DOCTYPE html>
<html class="no-js" lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{frontend/layout :: head('BabyMate', ~{::extraHead})}">
  <th:block th:fragment="extraHead"></th:block>
</head>

<body th:replace="~{frontend/layout :: layout('about', ~{::content}, ~{::extraJs}, 'footer-one')}">
<section th:fragment="content">
<div th:replace="~{frontend/fragments/breadcrumb :: breadcrumb('購物車')}"></div>


	<!-- page wrapper -->
	<!--=======  End of breadcrumb area =======-->

	<!--=============================================
	=            cart page content         =
	=============================================-->

	<div class="shopping-cart-area mb-130">
		<div class="container">
			<div class="row">
				<div class="col-lg-12 mb-30">
					<!--=======  cart table  =======-->

					<div class="cart-table-container">
						<table class="cart-table">
							<thead>
								<tr>
									<th class="product-name" colspan="2">商品</th>
									<th class="product-price">價格</th>
									<th class="product-quantity">數量</th>
									<th class="product-subtotal">合計</th>
									<th class="product-remove">&nbsp;</th>
								</tr>
							</thead>

							<tbody>
  <tr th:each="item : ${cartItems}">
    <td class="product-thumbnail">
      <a th:href="@{'/shop/product-basic/' + ${item.productId}}">
        <img th:src="@{/product/DBGifReader(productId=${item.productId})}" class="img-fluid" alt="商品主圖">
      </a>
    </td>
    <td class="product-name">
      <a th:href="@{'/shop/product-basic/' + ${item.productId}}"
         th:text="${item.productName}">Product Name</a>
    </td>
    <td class="product-price">
      <span class="price" th:text="'$' + ${#numbers.formatDecimal(item.price, 1, 'COMMA', 0, 'POINT')}" th:attr="data-price=${item.price}">$1,000</span>
    </td>
    <td class="product-quantity">
      <div class="pro-qty d-inline-block mx-0">
        <input type="number" th:attr="data-product-id=${item.productId}" 
          class="qty-input item-total" th:value="${item.quantity}"
           min="0" max="10" step="1"> 
      </div>
    </td>
    <td class="total-price">
      <span class="price item-total-price" th:text="'$' + ${#numbers.formatDecimal(item.totalPrice, 1, 'COMMA', 0, 'POINT')}">$1,000</span>
    </td>
    <td class="product-remove">
      <a href="#" th:attr="data-product-id=${item.productId}" class="remove-item-btn">
        <i class="ion-android-close"></i>
      </a>
    </td>
  </tr>
</tbody>
						</table>
					</div>

					<!--=======  End of cart table  =======-->
				</div>
				<div class="col-lg-12 mb-80">
					<!--=======  coupon area  =======-->

					<div class="cart-coupon-area pb-30">
						<div class="row align-items-center">
							<div class="col-lg-6 mb-md-30 mb-sm-30">
								<!--=======  coupon form  =======-->

								<div class="lezada-form coupon-form">
<!-- 									<form action="#"> -->
<!-- 										<div class="row"> -->
<!-- 											<div class="col-md-7 mb-sm-10"> -->
<!-- 												<input type="text" placeholder="Enter your coupon code"> -->
<!-- 											</div> -->
<!-- 											<div class="col-md-5"> -->
<!-- 												<button class="lezada-button lezada-button--medium">apply -->
<!-- 													coupon</button> -->
<!-- 											</div> -->
<!-- 										</div> -->
<!-- 									</form> -->
								</div>

								<!--=======  End of coupon form  =======-->
							</div>

<!-- 							<div class="col-lg-6 text-start text-lg-end"> -->
<!-- 								=======  update cart button  ======= -->

<!-- 								<button class="lezada-button lezada-button--medium">更新購物車</button> -->

<!-- 								=======  End of update cart button  ======= -->
<!-- 							</div> -->
						</div>
					</div>

					<!--=======  End of coupon area  =======-->
				</div>

				<div class="col-xl-4 offset-xl-8 col-lg-5 offset-lg-7">
					<div class="cart-calculation-area">
						<h2 class="mb-40">購物車</h2>

						<table class="cart-calculation-table mb-30">
							<tr>
								<th>數量小計</th>
								<td class="subtotal" th:text="${#numbers.formatDecimal(totalQty, 1, 'COMMA', 0, 'POINT')}">2</td>
							</tr>
							<tr>
								<th>金額總計</th>
								<td class="total" th:text="'$' + ${#numbers.formatDecimal(total, 1, 'COMMA', 0, 'POINT')}">$1,000</td>
							</tr>
						</table>

						<div>
							<a class="lezada-button lezada-button--medium" th:href="@{/shop/checkout}">結帳</a>
							<!-- <button class="lezada-button lezada-button--medium">結帳</button> -->
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!--=====  End of cart page content  ======-->


	<!--=============================================
	=            footer area         =
	=============================================-->

	<!-- end page wrapper -->
</section>
<th:block th:fragment="extraJs">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 如果還有你的頁面圖表初始化 JS，可放這裡 -->

<script>
<!-- 格式化金額為整數+comma $nnn,nnn-->
function formatPrice(price) {
  const num = parseFloat(price);
  if (isNaN(num)) return "$0";

  return "$" + num.toLocaleString("en-US", {
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  });
}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
	// 更新單品及購物車統計
	    function updateCart(productId, newQty, input) {
	        if (isNaN(newQty) || newQty < 0) return;

	        fetch(`/api/cart/update?productId=${productId}&quantity=${newQty}`, {
	            method: "PUT"
	        })
	        .then(res => res.json())
	        .then(data => {
	            const row = input.closest("tr");

	            // 更新單品小計
	            const priceEl = row.querySelector(".product-price .price");
				const price = parseFloat(priceEl.getAttribute("data-price"));
				row.querySelector(".item-total-price").innerText = (price * newQty).toFixed(2);

	            // 更新購物車統計
	            const formattedTotal = formatPrice(parseFloat(data.total).toFixed(2));
	            
	            document.querySelector(".subtotal").innerText = data.totalQty;
// 	            document.querySelector(".total").innerText = parseFloat(data.total).toFixed(2);
	            document.querySelector(".total").innerText = formattedTotal;
	            
	            setCartWishlistCount(data.totalQty);

	            // 數量為 0 → 移除該列
	            if (newQty === 0) row.remove();
	        })
	        .catch(err => console.error("更新數量失敗:", err));
	    }

	    // 監聽輸入框變化
	    document.querySelectorAll(".qty-input").forEach(input => {
	        input.addEventListener("change", function (e) {
	            const productId = input.dataset.productId;
	            const newQty = parseInt(input.value);
	            updateCart(productId, newQty, input);
	        });
	    });

	 // 事件委派監聽 + / - 按鈕
	    document.addEventListener("click", function(e) {
	        if (!e.target.closest(".pro-qty")) return;
	        const wrapper = e.target.closest(".pro-qty");
	        const input = wrapper.querySelector(".qty-input");
	        if (!input) return;

	        const productId = input.dataset.productId;
	        const newQty = parseInt(input.value);
	        updateCart(productId, newQty, input);
	    });
	});
</script>

<script>
document.addEventListener("click", function (e) {
    if (e.target.closest(".remove-item-btn")) {
        e.preventDefault();
        const btn = e.target.closest(".remove-item-btn");
        const productId = btn.getAttribute("data-product-id");

        fetch(`/api/cart/del/${productId}`, {
            method: "DELETE"
        })
        .then(res => res.json())
        .then(data => {
            // 移除該列
            btn.closest("tr").remove();

            // 更新右側統計數字
            const formattedTotal = formatPrice(data.total);
            
            document.querySelector(".subtotal").innerText = data.totalQty;
//             document.querySelector(".total").innerText = data.total;
            document.querySelector(".total").innerText = formattedTotal;
            
            setCartWishlistCount(data.totalQty);
        })
        .catch(err => console.error("刪除失敗:", err));
    }
});
</script>

<script>
document.addEventListener("change", function (e) {
    if (e.target.classList.contains("qty-input")) {
        const input = e.target;
        const productId = input.getAttribute("data-product-id");
        const newQty = input.value;

        fetch(`/api/cart/update?productId=${productId}&quantity=${newQty}`, {
            method: "PUT"
        })
        .then(res => res.json())
        .then(data => {
            const row = input.closest("tr");

            if (newQty <= 0) {
                // 數量歸零 → 直接刪掉該行
                row.remove();
            } else {
                // 更新單筆小計
                row.querySelector(".item-total").innerText = data.itemTotal;
            }

            // 更新右側統計數字
            const formattedTotal = formatPrice(data.total);
            
            document.querySelector(".subtotal").innerText = data.totalQty;
//             document.querySelector(".total").innerText = data.total;
            document.querySelector(".total").innerText = formattedTotal;
            
            setCartWishlistCount(data.totalQty);
        })
        .catch(err => console.error("更新數量失敗:", err));
    }
});
</script>

<script>
function setCartWishlistCount(n) {
  // header/行動版 可能有多個 count，一起更新
  document.querySelectorAll('.js-cart-count').forEach(el => {
    el.textContent = String(n);
  });
}
</script>

  </th:block>
</body>
</html>