<!DOCTYPE html>
<html class="no-js" lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{frontend/forum_layout :: forumHead(${post.postTitle} + ' - BabyMate', null)}"></head>

<body th:replace="~{frontend/forum_layout :: forumLayout(
                        pageTitle       = ${post.postTitle} + ' - BabyMate',
                        headerType      = 'forum',
                        content         = ~{:: pageContent},
                        extraJs         = ~{:: pageScripts},
                        footerClass     = 'footer-one',
                        breadcrumbTitle = ${breadcrumbTitle}
                     )}">

<th:block th:fragment="pageContent">
    <div class="forum-post card p-4 shadow-sm">
        <h3 class="mb-3" th:text="${post.postTitle}">文章標題</h3>
        
        <div class="post-meta text-muted border-bottom pb-3 mb-3">
            <span th:text="'看板：' + ${post.boardVO?.boardName}"></span>・
            <span th:text="'作者：' + ${T(com.babymate.forum.util.MaskingUtils).maskName(post.memberVO?.name)}"></span>・
            <span th:text="'時間：' + ${#dates.format(post.postTime, 'yyyy-MM-dd HH:mm')}"></span>
            
            <a href="#" class="like-btn" th:data-post-id="${post.postId}" style="text-decoration: none; font-size: 1.2rem; margin-left: 1rem;">
                <span th:if="${post.isLikedByCurrentUser()}">❤️</span>
                <span th:unless="${post.isLikedByCurrentUser()}">♡</span>
            </a>
        </div>
        
        <div class="post-content" th:utext="${post.postLine}">文章內容</div>
        <hr th:if="${session.member != null and post.memberVO.memberId == session.member.memberId}" />

<div class="post-actions text-end" th:if="${session.member != null and post.memberVO.memberId == session.member.memberId}">

    <a th:href="@{/forum/post/edit/{postId}(postId=${post.postId})}" class="btn btn-secondary">編輯文章</a>

    <form th:action="@{/forum/post/delete/{postId}(postId=${post.postId})}" method="post" style="display: inline;" onsubmit="return confirm('確定要刪除這篇文章嗎？');">
        <button type="submit" class="btn btn-danger ms-2">刪除文章</button>
    </form>

</div>
    </div>

    <div class="replies-section card p-4 shadow-sm mt-5">
        <h4 class="mb-4">共 <span th:text="${#lists.size(replyList)}">0</span> 則回覆</h4>
        
        <div th:if="${#lists.isEmpty(replyList)}">
            <p>還沒有人回覆，快來搶頭香！</p>
        </div>
        
        <div class="single-reply border-bottom pb-3 mb-3" th:each="reply : ${replyList}">
            <div class="reply-meta text-muted mb-2">
                <strong th:text="${T(com.babymate.forum.util.MaskingUtils).maskName(reply.memberVO?.name)}">回覆者</strong>

                <span class="ms-3" th:text="${#dates.format(reply.replyTime, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
            <div class="reply-content" th:utext="${reply.replyLine}"></div>
        </div>
    </div>

    <div class="reply-form-section card p-4 shadow-sm mt-5">
        <h4 class="mb-3">我要回覆</h4>
        <div th:if="${loggedInMember != null}">
            <form th:action="@{/forum/post/{postId}/reply(postId=${post.postId})}" method="post">
                <input type="hidden" name="boardId" th:value="${post.boardVO.boardId}" />
                <div class="mb-3">
                    <textarea class="form-control" name="replyLine" rows="4" placeholder="輸入你的回覆..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">送出回覆</button>
            </form>
        </div>
        <div th:if="${loggedInMember == null}">
            <p>請先<a th:href="@{/shop/login}">登入</a>後再進行回覆。</p>
        </div>
    </div>
</th:block>

	<th:block th:fragment="pageScripts">
		<script>
        // 把跟 forum.html 一模一樣的 AJAX 腳本複製過來
        document.addEventListener("DOMContentLoaded", function() {
            // 這裡的邏輯不太一樣，因為頁面上只有一個按鈕
            const likeButton = document.querySelector('.like-btn');
            if (likeButton) {
                likeButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    const postId = this.dataset.postId;
                    fetch(`/api/posts/${postId}/toggle-like`, { method: 'POST' })
                    .then(response => {
                        if (!response.ok) {
                            alert('請先登入才能收藏文章！');
                            throw new Error('Server error');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.liked) {
                            this.innerHTML = '<span>❤️</span>';
                        } else {
                            this.innerHTML = '<span>♡</span>';
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            }
        });
        </script>
	</th:block>

</body>
</html>