<!DOCTYPE html>
<html class="no-js" lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{frontend/layout :: head('BabyMate', ~{::extraHead})}">
  <th:block th:fragment="extraHead"></th:block>
</head>

<body th:replace="~{frontend/layout :: layout('about', ~{::content}, ~{::extraJs}, 'footer-one')}">
<section th:fragment="content">
<div th:replace="~{frontend/fragments/breadcrumb :: breadcrumb('我的會員資料')}"></div>


	<!-- page wrapper -->
	<!-- My account content --> 
	<div class="my-account-area mb-130 mb-md-70 mb-sm-70 mb-xs-70 mb-xxs-70">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="row">
          <!-- 側邊選單 -->
          <div class="col-lg-12 col-md-12">
            <div class="myaccount-tab-menu nav" role="tablist">
<!--               <a href="#dashboad" class="active" data-bs-toggle="tab">Dashboard</a> -->
<!--               <a href="#orders" data-bs-toggle="tab">Orders</a> -->
<!--               <a href="#download" data-bs-toggle="tab">Download</a> -->
<!--               <a href="#payment-method" data-bs-toggle="tab">Payment Method</a> -->
              <a href="#account-info" class="active" data-bs-toggle="tab">基本資料</a>
              <a href="#password-info" data-bs-toggle="tab">密碼變更</a>
              <a href="#weather-info" data-bs-toggle="tab">即時天氣</a>
<!--               <a th:href="@{/shop/customer-login}">Logout</a> -->
            </div>
          </div>

          <!-- 內容區 -->
          <div class="col-lg-12 col-md-12">
            <div class="tab-content" id="myaccountContent">

              <!-- Account Info -->
              <div class="tab-pane fade show active" id="account-info" role="tabpanel">
                <div class="myaccount-content">
                  <h3>基本資料</h3>
                  <div class="account-details-form">
<!--                     <form action="#" method="post" enctype="multipart/form-data"> -->
					<form id="editFormInfo" th:action="@{/member/updateBasicInfo}" method="post" th:object="${MemberVO}" enctype="multipart/form-data">
                      <div class="row">
                        <!-- 左側欄 -->
                        <div class="col-lg-6">   
                          <div>
                          	<input type="hidden" th:field="*{memberId}" />
                          </div>                                     
                          <div class="single-input-item">
                            <label for="full-name" class="required">姓名</label>
                            <input type="text" th:field="*{name}" id="full-name" class="form-control fs-6" 
                            	required minlength="2" maxlength="20"
         						pattern="^[\u4e00-\u9fa5a-zA-Z\s]+$"
         						title="請輸入中文或英文姓名 (2-20字)" />
                            <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="error" id="name.errors"></span>
                          </div>
                          <div class="single-input-item mt-3">
                            <label for="birthday" class="required">生日</label>
<!--                             <input type="date" th:field="*{birthday}" id="birthday" class="form-control" /> -->
							<!-- 前端date picker不支援thymeleaf th:field寫法, 故改用以下方式傳值 -->
							<input type="date" th:value="${#temporals.format(MemberVO.birthday, 'yyyy-MM-dd')}"
       							name="birthday" class="form-control fs-6" />
                            <span th:if="${#fields.hasErrors('birthday')}" th:errors="*{birthday}" class="error" id="birthday.errors"></span>
                          </div>
                          <div class="single-input-item mt-3">
                            <label for="gender" class="required">性別</label>
                            <select id="gender" class="form-control" th:field="*{gender}">
    							<option value="" disabled>請選擇性別</option>
    							<option value="女">女</option>
    							<option value="男">男</option>
    							<option value="其他">其他</option>
  							</select>
                          </div>
                          <!-- Addressee -->
                          <div class="single-input-item">
                            <label for="recipient" >收件人</label>
                            <input type="text" th:field="*{recipientName}" id="recipientName" class="form-control fs-6" />
                            <span th:if="${#fields.hasErrors('recipientName')}" th:errors="*{recipientName}" class="error" id="recipientName.errors"></span>
                          </div>
                          
                          <div class="single-input-item">
                            <label for="address" >地址</label>
                            <input type="text" th:field="*{address}" id="address" class="form-control fs-6" />
                            <span th:if="${#fields.hasErrors('address')}" th:errors="*{address}" class="error" id="address.errors"></span>
                          </div>
                          
                          <div class="single-input-item">
                            <label for="phone" >電話</label>
                            <input type="tel" th:field="*{phone}" id="phone" class="form-control fs-6" />
                            <span th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}" class="error" id="phone.errors"></span>
                          </div>
                          
                          <!-- 儲存變更按鈕 -->
                          <div class="single-input-item mt-4">
                            <div class="row">
                              <div class="col-6">
                                <button type="submit" class="check-btn sqr-btn w-100">儲存變更</button>
                              </div>
                              <div class="col-6">
                                <button type="reset" class="check-btn sqr-btn w-100">重設</button>
                              </div>
                            </div>
                          </div>
                        </div>
                        <!-- 右側欄 -->
                        <div class="col-lg-6 text-center">
                          <div class="single-input-item">
                            <label class="required d-block mb-2">頭像</label>                             
                             <img id="avatar-preview" th:src="@{/util/DBPicReader1} + '?memberId=' + ${MemberVO.memberId}"
										alt="頭像預覽" class="img-thumbnail mb-3"
                              style="width: 250px; height: 250px; object-fit: cover;"/>
                              
                            <div class="d-flex justify-content-center">
                              <label for="avatar-upload" class="btn btn-outline-primary">選擇頭像</label>
                              <input type="file" id="avatar-upload" name="pic" accept="image/*"
                                class="d-none" onchange="previewImage(event)" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </form>
                    <!-- 錯誤表列 -->
					<p></p>
<!-- 					<div class="errorblock  text-left" th:if="${errorMessage}" th:text="${errorMessage}"></div> -->
<!-- 					<div class="successblock  text-left" th:if="${logoutMessage}" th:text="${logoutMessage}"></div> -->
					<div class="alert alert-danger d-flex align-items-center mt-4" role="alert" th:if="${errorMessage}">
  						<i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
  						<span th:text="${errorMessage}"></span>
					</div>
					<div class="alert alert-success fade-in d-flex align-items-center mt-4" role="alert" th:if="${successMessage}">
  						<i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
  						<span th:text="${successMessage}"></span>
					</div>
					<!-- 錯誤表列 -->
                  </div>
                </div>
              </div>
              <!-- /Account Info -->

			  <!-- Password Info -->
			  			  
			  <div class="tab-pane fade" id="password-info" role="tabpanel">
                <div class="myaccount-content">
                  <h3>密碼變更</h3>
                  <form id="editFormPwd" th:action="@{/member/updatePassword}" method="post" th:object="${MemberVO}" enctype="multipart/form-data">
                    <div class="row">
                        <!-- 左側欄 -->
                        <div class="col-lg-12">  
                        
						<div>
                          	<input type="hidden" id="memberId-pwd" th:field="*{memberId}" />
                        </div>
                        
                        <input type="text" name="username" autocomplete="username" value="[[${MemberVO.account}]]" hidden />

                        <div class="single-input-item  mt-3">
                          <label for="current-pwd" class="required">目前密碼</label>
                          <input type="password" id="current-pwd" th:field="*{password}"
                            placeholder="請輸入目前密碼" autocomplete="current-password"
                            pattern="[A-Za-z0-9]+" title="僅允許數字或英文大小寫" maxlength="20" class="form-control fs-6" required />
                        </div>
                        <div class="row">
                          <div class="col-lg-6">
                            <div class="single-input-item  mt-3">
                              <label for="new-pwd" class="required">新密碼</label>
                              <input type="password" id="new-pwd" name="newPassword"
                                placeholder="請輸入新密碼" autocomplete="new-password"
                                pattern="[A-Za-z0-9]+" title="僅允許數字或英文大小寫" maxlength="20" class="form-control fs-6" required />
                            </div>
                          </div>
                          <div class="col-lg-6">
                            <div class="single-input-item  mt-3">
                              <label for="confirm-pwd" class="required">確認新密碼</label>
                              <input type="password" id="confirm-pwd" name="confirmPassword"
                                placeholder="請再次輸入新密碼" autocomplete="new-password"
                                pattern="[A-Za-z0-9]+" title="僅允許數字或英文大小寫" maxlength="20" class="form-control fs-6" required />
                            </div>
                          </div>
                        </div>
                        <!-- 儲存變更按鈕 -->
                          <div class="single-input-item mt-4">
                            <div class="row">
                              <div class="col-6">
<!--                                 <button type="submit" class="check-btn sqr-btn w-100">密碼變更</button> -->
									 <button type="submit" class="btn btn-outline-success w-100 d-flex align-items-center justify-content-center gap-2">
  										<i class="bi bi-shield-lock-fill"></i> 密碼變更
									 </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </form>
                    <!-- 錯誤表列 -->
					<p></p>
<!-- 					<div class="errorblock  text-left" th:if="${errorMessage}" th:text="${errorMessage}"></div> -->
<!-- 					<div class="successblock  text-left" th:if="${logoutMessage}" th:text="${logoutMessage}"></div> -->
					<div class="alert alert-danger d-flex align-items-center mt-4" role="alert" th:if="${errorMessage}">
  						<i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
  						<span th:text="${errorMessage}"></span>
					</div>
					<div class="alert alert-success fade-in d-flex align-items-center mt-4" role="alert" th:if="${successMessage}">
  						<i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
  						<span th:text="${successMessage}"></span>
					</div>
					<!-- 錯誤表列 -->
                </div>
              </div>
			  <!-- /Password Info -->
			  
			  <!-- Weather Info --> 			  
			  <div class="tab-pane fade" id="weather-info" role="tabpanel">
                <div class="myaccount-content">
                    <h1>🌦 即時天氣</h1>
                    <div id="result" class="weather-box p-4 border rounded text-left shadow-sm">
  						正在載入天氣資訊...
					</div>
                    <!-- 錯誤表列 -->
					<!-- /錯誤表列 -->
                </div>
              </div>
			  <!-- /Weather Info -->

            </div>
          </div>
          <!-- /tab content -->
        </div>
      </div>
    </div>
  </div>
</div>

	<!-- end page wrapper -->
</section>
<th:block th:fragment="extraJs">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 如果還有你的頁面圖表初始化 JS，可放這裡 -->
    
    <script>
document.getElementById("editFormPwd").addEventListener("submit", function(event) {
  const newPwd = document.getElementById("new-pwd").value;
  const confirmPwd = document.getElementById("confirm-pwd").value;

  if (newPwd !== confirmPwd) {
    event.preventDefault(); // 阻止提交
    alert("新密碼與確認密碼不一致！");
  }
});
</script>
    
	 <!-- 頭像預覽 -->
  <script>
    function previewImage(event) {
      const reader = new FileReader();
      reader.onload = function () {
        document.getElementById('avatar-preview').src = reader.result;
      };
      reader.readAsDataURL(event.target.files[0]);
    }
  </script>
  
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const hash = window.location.hash;

    if (hash) {
      // 移除所有 tab 的 active 樣式
      document.querySelectorAll('.myaccount-tab-menu a').forEach(function (tabLink) {
        tabLink.classList.remove('active');
      });

      document.querySelectorAll('.tab-pane').forEach(function (tabPane) {
        tabPane.classList.remove('show', 'active');
      });

      // 套用新的 active 樣式
      const targetTabLink = document.querySelector(`.myaccount-tab-menu a[href="${hash}"]`);
      const targetTabPane = document.querySelector(hash);

      if (targetTabLink && targetTabPane) {
        targetTabLink.classList.add('active');
        targetTabPane.classList.add('show', 'active');
      }
    }
  });
</script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
	  const alertBoxes = document.querySelectorAll('.alert');
	  alertBoxes.forEach((alertBox) => {
	    setTimeout(() => {
	      alertBox.style.transition = 'opacity 0.5s ease';
	      alertBox.style.opacity = '0';
	      setTimeout(() => alertBox.remove(), 500);
	    }, 3000); // 3 秒後消失
	  });
	});
</script>

  <script>
    window.onload = function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          fetch(`/member/weather?lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
            	document.getElementById("result").innerHTML = `
            		  <div class="fs-5 mb-2">地區: <strong>${data.city}</strong></div>
            		  <div class="fs-5 mb-2">溫度: <span class="text-primary fw-bold">${data.temp}°C</span></div>
            		  <div class="fs-5 mb-2">天氣: <span class="text-secondary">${data.description}</span></div>
            		`;
            })
            .catch(err => {
              document.getElementById("result").innerText = "無法取得天氣資訊";
              console.error(err);
            });
        }, function(error) {
          document.getElementById("result").innerText = "無法取得定位，請允許瀏覽器存取位置";
        });
      } else {
        document.getElementById("result").innerText = "瀏覽器不支援定位功能";
      }
    }
  </script>
        
  </th:block>
</body>
</html>
