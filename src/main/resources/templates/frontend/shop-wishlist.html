<!DOCTYPE html>
<html class="no-js" lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head
	th:replace="~{frontend/layout :: head('BabyMate', ~{::extraHead})}">
<th:block th:fragment="extraHead"></th:block>
</head>

<body
	th:replace="~{frontend/layout :: layout('about', ~{::content}, ~{::extraJs}, 'footer-one')}">
	<section th:fragment="content">
		<div
			th:replace="~{frontend/fragments/breadcrumb :: breadcrumb('我的收藏')}"></div>

		<!--=============================================
  =            wishlist page content              =
  =============================================-->
		<div class="shopping-cart-area mb-130">
			<div class="container">
				<div class="row">
					<div class="col-lg-12">

						<!-- cart table -->
						<div class="cart-table-container">
							<table class="cart-table">
								<thead>
									<tr>
										<th class="product-name" colspan="2">Product</th>
										<th class="product-price">Price</th>
										<th class="product-quantity">Quantity</th>
										<th class="product-subtotal">&nbsp;</th>
										<th class="product-remove">&nbsp;</th>
									</tr>
								</thead>
								<tbody>
									<tr th:if="${#lists.isEmpty(wishlistProducts)}">
										<td colspan="6" class="text-center py-4">目前沒有收藏的商品</td>
									</tr>

									<tr th:each="p : ${wishlistProducts}">
										<td class="product-thumbnail"><a
											th:href="@{/shop/product-basic(id=${p.productId})}"> <img
												th:src="@{/product/DBGifReader(productId=${p.productId})}"
												class="img-fluid" th:alt="${p.productName}">
										</a></td>
										<td class="product-name"><a
											th:href="@{/shop/product-basic(id=${p.productId})}"
											th:text="${p.productName}">Product</a> <span
											class="product-variation" th:text="${p.featureDesc}">特色</span>
										</td>
										<td class="product-price"><span class="price"
											th:text="'NT$' + ${p.price}">NT$0</span></td>
										<td class="product-quantity">
											<div class="pro-qty d-inline-block mx-0">
												<input type="text" value="1">
											</div>
										</td>
										<td class="add-to-cart">
											<button
												class="lezada-button lezada-button--small lezada-button--icon--left">
												<i class="ion-ios-cart-outline"></i> 加入購物車
											</button>
										</td>
										<td class="product-remove"><a href="javascript:void(0)"
											class="btn-remove-fav"
											th:attr="data-product-id=${p.productId}"> <i
												class="ion-android-close"></i>
										</a></td>
									</tr>
								</tbody>

							</table>
						</div>
						<!-- End of cart table -->

					</div>
				</div>
			</div>
		</div>
		<!--=====  End of wishlist page content  ======-->

	</section>
	<th:block th:fragment="extraJs">
<!-- <script th:inline="javascript">
document.addEventListener('click', async function(e){
  const btn = e.target.closest('.btn-remove-fav');
  if(!btn) return;

  const pid = btn.getAttribute('data-product-id') || btn.dataset.productId;
  if (!pid) return;

  const row = btn.closest('tr');

  const toggleUrl = /*[[@{/api/wishlist/toggle}]]*/ '/api/wishlist/toggle';
  const loginUrl  = /*[[@{/shop/login}]]*/ '/shop/login';  // ← 用 Thymeleaf 展開

  try {
    const res = await fetch(toggleUrl, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({ productId: pid })
    });

    if (res.status === 401) { location.href = loginUrl; return; }
    if (!res.ok) { alert('操作失敗 ('+res.status+')'); return; }

    row.remove();
    const tbody = document.querySelector('.cart-table tbody');
    if (tbody && tbody.querySelectorAll('tr .btn-remove-fav').length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="6" class="text-center py-4">目前沒有收藏的商品</td>';
      tbody.appendChild(tr);
    }
  } catch (err) { console.error(err); }
});
</script> -->
<script th:inline="javascript">
document.addEventListener('click', async function(e){
  const btn = e.target.closest('.btn-remove-fav');
  if (!btn) return;
  e.preventDefault();

  // 避免連點重複送出
  if (btn.dataset.busy === '1') return;
  btn.dataset.busy = '1';

  const pid = btn.getAttribute('data-product-id') || btn.dataset.productId;
  if (!pid) { btn.dataset.busy = '0'; return; }

  const row = btn.closest('tr');
  const toggleUrl = /*[[@{/api/wishlist/toggle}]]*/ '/api/wishlist/toggle';
  const loginUrl  = /*[[@{/shop/login}]]*/ '/shop/login';

  try {
    const res = await fetch(toggleUrl, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({ productId: pid })
    });

    if (res.status === 401) { location.href = loginUrl; return; }
    if (!res.ok) { 
      window.Swal ? Swal.fire({icon:'error', title:'操作失敗', text:'伺服器回應 ' + res.status}) 
                  : alert('操作失敗 (' + res.status + ')');
      return;
    }

    // 移除該列
    row.remove();

    // 如果清單已空，補一列空狀態
    const tbody = document.querySelector('.cart-table tbody');
    if (tbody && !tbody.querySelector('.btn-remove-fav')) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="6" class="text-center py-4">目前沒有收藏的商品</td>';
      tbody.appendChild(tr);
    }

    // 通知 overlays mini 也刷新
    document.dispatchEvent(new Event('wishlist:changed'));

    // ✅ SweetAlert：已取消收藏
    if (window.Swal) {
      Swal.fire({
        icon: 'info',
        title: '已取消收藏',
        showConfirmButton: false,
        timer: 1200,
     // toast效果
        //position: 'top-end',        
        //toast:true,
        //timerProgressBar:true
      });
    } else {
      alert('已取消收藏');
    }
  } catch (err) {
    console.error(err);
    window.Swal ? Swal.fire({icon:'error', title:'網路或伺服器錯誤'}) 
                : alert('網路或伺服器錯誤');
  } finally {
    btn.dataset.busy = '0';
  }
});
</script>

</th:block>


</body>
</html>

