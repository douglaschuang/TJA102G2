<!DOCTYPE html>
<html class="no-js" lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{frontend/layout :: head('BabyMate', ~{::extraHead})}">
  <th:block th:fragment="extraHead"></th:block>
  <style>
  button:disabled {
  background-color: #ccc !important;
  cursor: not-allowed;
  border-color: #ccc !important;
}
  </style>
</head>

<body th:replace="~{frontend/layout :: layout('about', ~{::content}, ~{::extraJs}, 'footer-one')}">
<section th:fragment="content">
<div th:replace="~{frontend/fragments/breadcrumb :: breadcrumb('登入與註冊')}"></div>



	<!-- page wrapper --> 
	<!--=============================================
    =            login page content         =
    =============================================-->

	<div class="login-area mb-130 mb-md-70 mb-sm-70 mb-xs-70 mb-xxs-70">
		<div class="container">
			<div class="row">
				<div class="col-lg-6 mb-md-50 mb-sm-50">
					<div class="lezada-form login-form">
							<div class="row">
								<div class="col-lg-12">
									<!--=======  login title  =======-->

									<div
										class="section-title section-title--login text-center mb-50">
										<h2 class="mb-20">會員登入</h2>
										
										<!-- 檢查是否已登入提示訊息 -->
										<div class="alert alert-danger d-flex align-items-center mt-4 justify-content-center" role="alert" th:if="${session.member}">
  											<i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
  											<span th:text="'提示: '+ ${session.member.account} + ' 您已登入.'"></span>
										</div>
										
										<p>歡迎回來! Great to have you back!</p>
									</div>

								<!-- 錯誤表列 (登入驗證) -->
								<div class="alert alert-danger d-flex align-items-center mt-4" role="alert" th:if="${errorMessage} and ${errorSource} == 'login'">
  									<i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
  									<span th:text="${errorMessage}"></span>
								</div>
								<div class="alert alert-success fade-in d-flex align-items-center mt-4" role="alert" th:if="${logoutMessage} and ${logoutSource} == 'login'">
  									<i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
  									<span th:text="${logoutMessage}"></span>
								</div>
								<!-- 錯誤表列 (登入驗證) -->
									
									<!-- 錯誤表列 (忘記密碼) -->
								<div class="alert alert-danger d-flex align-items-center mt-4" role="alert" th:if="${errorMessage} and ${errorSource} == 'resetpwd'">
  									<i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
  									<span th:text="${errorMessage}"></span>
								</div>
								<div class="alert alert-success fade-in d-flex align-items-center mt-4" role="alert" th:if="${logoutMessage} and ${logoutSource} == 'resetpwd'">
  									<i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
  									<span th:text="${logoutMessage}"></span>
								</div>
								<!-- 錯誤表列 (忘記密碼) -->

									<!--=======  End of login title  =======-->
								</div>
								<form th:action="@{/member/loginCheck}" method="post" onsubmit="return validateLoginForm()">
								<div class="col-lg-12 mb-60">
									<input type="text" name="accountLogin" id="accountInput" th:value="${accountLogin}" placeholder="請輸入會員帳號(Email address)" autocomplete="username"
										maxlength="50" required pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="請輸入有效的Email地址">
								</div>
								<div class="col-lg-12 mb-60">
									<input type="password" name="password" placeholder="請輸入密碼(Password)" autocomplete="current-password" 
									maxlength="20" required pattern="^[A-Za-z0-9]+$" title="密碼僅能包含數字與英文大小寫">
								</div>
								<div class="col-lg-12 text-center mb-30">
									<button type="submit" class="lezada-button lezada-button--medium">登入</button>
								</div>
								</form>
								
                                <form id="forgotPwdForm" th:action="@{/member/memberForgotPwd}" method="post">
								<div class="col-lg-12 text-center">
                                    <input type="hidden" name="account" id="hiddenAccount">
  									<button type="submit" id="forgotPwdBtn" class="btn btn-sm btn-outline-secondary">忘記密碼</button>
								</div>
								</form>
								
								
							</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="lezada-form login-form--register">
							<div class="row">
								<div class="col-lg-12">
									<!--=======  login title  =======-->

									<div
										class="section-title section-title--login text-center mb-50">
										<h2 class="mb-20">會員註冊</h2>
										<p>註冊一個新會員吧! Register now!</p>
									</div>
									
                    <!-- 錯誤表列 (註冊驗證) -->
					<div class="alert alert-danger d-flex align-items-center mt-4" role="alert" th:if="${errorMessage} and ${errorSource} == 'register'">
  						<i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
  						<span th:text="${errorMessage}"></span>
					</div>
					<div class="alert alert-success fade-in d-flex align-items-center mt-4" role="alert" th:if="${logoutMessage} and ${logoutSource} == 'register'">
  						<i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
  						<span th:text="${logoutMessage}"></span>
					</div>
					<!-- 錯誤表列 (註冊驗證) -->
					
									<!--=======  End of login title  =======-->
								</div>
								<form th:action="@{/member/registerCheck}" method="post" onsubmit="return validateRegisterForm()">
								<div class="col-lg-12 mb-30">
									<label for="regEmail">會員帳號 (Email Address) <span	class="required">*</span></label>
									<input type="text" id="regEmail" name="account" maxlength="50" th:value="${account}" autocomplete="email" required
									pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
								</div>
								<div class="col-lg-12 mb-30">
									<label for="regPassword">信箱驗證碼 <span	class="required">*</span></label> 
									<div class="d-flex justify-content-between align-items-center me-2">
									  <input type="text" id="authcode" name="captcha" maxlength="6" th:value="${captcha}" autocomplete="off" style="max-width: 300px;" >
									  <button type="button" id= "sendCodeBtn" class="btn btn-primary">發送驗證碼</button>
									</div>
								</div>
								<div class="col-lg-12 mb-30">
									<label for="regPassword">密碼 (Password) <span class="required">*</span></label>
									<input type="password" id="regPassword" name="password" maxlength="20" 
									  pattern="[A-Za-z0-9]+" title="僅允許數字或英文大小寫"  autocomplete="current-password" required>
								</div>
								<div class="col-lg-12 mb-30">
									<label for="regPassword">確認密碼 (Password Confirmation) <span class="required">*</span></label>
									<input type="password" id="reRegPassword" maxlength="20" 
									  pattern="[A-Za-z0-9]+" title="僅允許數字或英文大小寫" autocomplete="current-password" required>
								</div>
								<div class="col-lg-12 text-center">
									<button type="submit" class="lezada-button lezada-button--medium">註冊</button>
								</div>
								</form>
							
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!--=====  End of login content  ======-->
	<!-- end page wrapper -->
</section>
<th:block th:fragment="extraJs">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 如果還有你的頁面圖表初始化 JS，可放這裡 -->
    
    <script>
      let timer = null;  // 提升到全域
    
	  function startCountdown() {
		    let timeLeft = 60;
		    sendBtn.disabled = true;
		    sendBtn.textContent = `重新發送 (${timeLeft})`;

		    if (timer) clearInterval(timer); // 避免重複計時
		    
		    timer = setInterval(() => {
		      timeLeft--;
		      sendBtn.textContent = `重新發送 (${timeLeft})`;

		      if (timeLeft <= 0) {
		        clearInterval(timer);
		        timer = null;
		        sendBtn.disabled = false;
		        sendBtn.textContent = '發送驗證碼';
		      }
		    }, 1000);
		  }
	
	  const sendBtn = document.getElementById('sendCodeBtn');
	  let countdown = null;

	  sendBtn.addEventListener('click', function () {  
	    const account = document.getElementById('regEmail').value; // 從輸入框取 Email

	    if (!account) {
	      alert("請輸入 Email 帳號！");
	      return;
	    }
	    
	    sendBtn.disabled = true;
		sendBtn.textContent = "發送中...";

	    // 呼叫後端 API 發送驗證碼
	    fetch('/member/resendAuthCode', {
	      method: 'POST',
	      headers: { 'Content-Type': 'application/json' },
	      body: JSON.stringify({ account: account })
	    })
	    .then(response => {
	      if (!response.ok) {
	        sendBtn.disabled = false;
	    	sendBtn.textContent = "發送驗證碼";
	        throw new Error("發送失敗");
	      }
	      return response.json();
	    })
	    .then(data => {
	      console.log("後端回應:", data);
	      
	      if (!data.success) {
	    	    sendBtn.disabled = false;
	    	    sendBtn.textContent = "發送驗證碼";
	    	    alert(data.message || "發送失敗");
	    	    return;
	    	  }
	      
	      alert("驗證碼已寄出，請查看信箱");

	      // 如果後端成功，才開始倒數
	      startCountdown();
	    })
	    .catch(error => {
	      console.error(error);
	      sendBtn.disabled = false;
	      sendBtn.textContent = "發送驗證碼";
	      alert("寄送驗證碼失敗，請稍後再試");
	    });
	  });

  </script>
  
  <script>
  document.addEventListener("DOMContentLoaded", function () { 
    const alertBox = document.querySelector('.alert');
    if (alertBox) {
      setTimeout(() => {
        alertBox.style.transition = 'opacity 0.5s ease';
        alertBox.style.opacity = '0';
        setTimeout(() => alertBox.remove(), 500);
      }, 3000); // 5 秒後消失
    }
  });
  
  window.onload = function() {
	    console.log("window onload.")
	    var memberId = sessionStorage.getItem("memberId");
	    console.log("my-account page, memberId from sessionStorage:", memberId);

	    if (memberId) {
	      sessionStorage.setItem("memberId", memberId);
	    }	  
  }
</script>

<script>
  document.getElementById("forgotPwdForm").addEventListener("submit", function(e) {
    const accountValue = document.getElementById("accountInput").value.trim();
    document.getElementById("hiddenAccount").value = accountValue;

    if (!accountValue) {
      alert("請先輸入帳號再使用忘記密碼！");
      e.preventDefault(); // 阻止送出
      return;
    }
    
    // 送出時禁用按鈕，避免重複點擊
    const forgotBtn = document.getElementById("forgotPwdBtn");
    forgotBtn.disabled = true;
    forgotBtn.textContent = "處理中...";

    // 幾秒後自動恢復（避免卡死）
    setTimeout(() => {
      forgotBtn.disabled = false;
      forgotBtn.textContent = "忘記密碼";
    }, 10000); // 10 秒後解鎖
  });
</script>

<script>
function validateLoginForm() {
    const accountInput = document.getElementById("accountInput").value;
    const passwordInput = document.getElementsByName("password")[0].value;

    // 檢查帳號是否為有效的 email 格式
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (!emailRegex.test(accountInput)) {
        alert("請輸入有效的 Email 地址");
        return false;
    }

    // 檢查密碼的格式是否正確
    const passwordRegex = /^[A-Za-z0-9]+$/;
    if (!passwordRegex.test(passwordInput)) {
        alert("密碼僅能包含數字與英文大小寫");
        return false;
    }

    return true;
}
</script>

<script>
function validateRegisterForm() {
    const emailInput = document.getElementById("regEmail").value;
    const captchaInput = document.getElementById("authcode").value;
    const passwordInput = document.getElementById("regPassword").value;
    const confirmPasswordInput = document.getElementById("reRegPassword").value;

    // 檢查 Email 格式
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (!emailRegex.test(emailInput)) {
        alert("請輸入有效的 Email 地址");
        return false;
    }

    // 檢查驗證碼是否填寫
    if (!captchaInput) {
        alert("請輸入信箱驗證碼");
        return false;
    }

    // 密碼與確認密碼是否一致
    if (passwordInput !== confirmPasswordInput) {
        alert("密碼與確認密碼不一致");
        return false;
    }

    // 檢查密碼格式
    const passwordRegex = /^[A-Za-z0-9]+$/;
    if (!passwordRegex.test(passwordInput)) {
        alert("密碼僅能包含數字與英文大小寫");
        return false;
    }

    return true;
}
</script>


    
  </th:block>
</body>
</html>
