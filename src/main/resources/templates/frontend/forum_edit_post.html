<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{frontend/forum_layout :: forumHead('編輯文章', ~{:: extraHead})}">
    <th:block th:fragment="extraHead">
        <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    </th:block>
</head>


<body th:replace="~{frontend/forum_layout :: forumLayout(
    pageTitle       = '編輯文章',
    headerType      = 'forum',
    content         = ~{:: pageContent},
    extraJs         = ~{:: pageScripts}, 
    footerClass     = 'footer-one',
    breadcrumbTitle = '編輯文章'
)}">

    <th:block th:fragment="pageContent">
        <div class="edit-post-container card p-4 shadow-sm">
            
            <h4 class="mb-3">正在編輯文章：「<span th:text="${postVO.postTitle}"></span>」</h4>

            <form id="editPostForm" th:action="@{/forum/post/update}" th:object="${postVO}" method="post">

                <input type="hidden" th:field="*{postId}" />

                <div class="mb-3">
                    <label for="postTitle" class="form-label">文章標題</label>
                    <input type="text" id="postTitle" class="form-control" th:field="*{postTitle}" required />
                </div>

                <div class="mb-3">
                    <label for="postLine" class="form-label">文章內容</label>
                    <textarea id="postLine" class="form-control" th:field="*{postLine}" rows="10"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">儲存變更</button>
                <a th:href="@{/forum/board/{boardId}/post/{postId}(boardId=*{boardVO.boardId}, postId=*{postId})}" class="btn btn-secondary">取消</a>
            </form>
        </div>
    </th:block>
	
	<th:block th:fragment="pageStyles"></th:block>
	
	<th:block th:fragment="pageScripts">
        <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/lang/summernote-zh-TW.min.js"></script>
        
        <script>
            $(document).ready(function() {
                // 初始化 Summernote 編輯器
                $('#postLine').summernote({
                    placeholder: '編輯你的內容...',
                    height: 400,
                    lang: 'zh-TW',
                    focus: true, // 載入頁面後自動聚焦到編輯器
                    callbacks: {
                        onImageUpload: function(files) {
                            var file = files[0];
                            var formData = new FormData();
                            formData.append('upload', file);
                            
                            $.ajax({
                                url: '/forum/uploadImage',
                                method: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: function(response) {
                                    if (response && response.url) {
                                        $('#postLine').summernote('insertImage', response.url);
                                    } else {
                                        alert('圖片上傳成功，但伺服器回傳格式錯誤！');
                                    }
                                },
                                error: function() {
                                    alert('圖片上傳 AJAX 請求失敗！');
                                }
                            });
                        }
                    }
                });

                // 同樣加上表單提交前的同步邏輯，確保修改後的內容能被送出
                $('#editPostForm').on('submit', function() {
                    var summernoteContent = $('#postLine').summernote('code');
                    $('#postLine').val(summernoteContent);
                });
            });
        </script>
    </th:block>

</body>
</html>